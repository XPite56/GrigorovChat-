<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GrigorovChat Admin</title>
    <style>
        :root { 
            --p: #6c5ce7; 
            --bg: #0f0c29; 
            --glass: rgba(255,255,255,0.1); 
            --admin: #ffd700;
            --grad: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--grad); color: white; height: 100vh; display: flex; overflow: hidden; }

        .screen { display: none; flex-direction: column; width: 100%; height: 100vh; position: absolute; }
        .active { display: flex; }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .card { background: #1a1a2e; padding: 30px; border-radius: 24px; width: 90%; max-width: 360px; text-align: center; border: 1px solid var(--glass); margin: auto; }
        input { background: rgba(255,255,255,0.1); border: 1px solid transparent; padding: 12px; border-radius: 15px; color: white; outline: none; width: 100%; margin-bottom: 10px; }
        
        .btn { background: var(--p); border: none; color: white; padding: 12px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }

        /* –®–∞–ø–∫–∞ */
        .header { padding: 15px 20px; background: rgba(255,255,255,0.05); display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass); }
        .avatar { width: 45px; height: 45px; background: var(--p); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .is-admin-border { border: 2px solid var(--admin); box-shadow: 0 0 10px var(--admin); }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .user-item { padding: 15px; margin: 8px 15px; background: var(--glass); border-radius: 18px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .crown { color: var(--admin); font-size: 1.2rem; margin-left: auto; }

        /* –ß–∞—Ç */
        .msg-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; position: relative; }
        .my { align-self: flex-end; background: var(--p); border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: var(--glass); border-bottom-left-radius: 2px; }
        .admin-glow { border: 1px solid var(--admin) !important; box-shadow: 0 0 5px var(--admin); }
        
        .time { font-size: 0.65rem; opacity: 0.6; display: block; margin-top: 5px; text-align: right; }
        .input-bar { padding: 15px; background: #1a1a2e; display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen active">
        <div class="card">
            <h1>GrigorovChat</h1><br>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleAuth()">–í–û–ô–¢–ò / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        </div>
    </div>

    <div id="screen-name" class="screen">
        <div class="card">
            <h3>–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</h3><br>
            <input type="text" id="user-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
            <button class="btn" onclick="saveNewName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <header class="header">
            <b id="my-display-name">GrigorovChat</b>
            <button onclick="logout()" style="margin-left:auto; background:none; border:none; color:#ff4757; cursor:pointer;">–í—ã—Ö–æ–¥</button>
        </header>
        <div style="padding:15px;"><input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="filterUsers()"></div>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="screen-chat" class="screen">
        <header class="header">
            <span onclick="showMain()" style="cursor:pointer; font-size:20px;">‚Üê</span>
            <div id="chat-avatar" class="avatar" style="width:35px; height:35px; font-size:14px;">?</div>
            <div>
                <b id="chat-with-name">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</b>
                <div id="typing-status" style="font-size:10px; color:#00d2ff;"></div>
            </div>
        </header>
        <div id="msg-box"></div>
        <div class="input-bar">
            <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()" style="margin:0;">
            <button onclick="sendMsg()" style="background:var(--p); border:none; color:white; width:45px; height:45px; border-radius:12px; cursor:pointer;">‚û§</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBv0usnYrMaGGm7ubItPKgtFNY_0JWlTS8",
        authDomain: "grigorovchat.firebaseapp.com",
        databaseURL: "https://grigorovchat-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "grigorovchat",
        storageBucket: "grigorovchat.firebasestorage.app",
        messagingSenderId: "751125712074",
        appId: "1:751125712074:web:f14ec596ab00695a04b833"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const ADMIN_EMAIL = "daniilgrigorov26@gmail.com";

    let me = null;
    let currentChatId = null;
    let allUsers = [];

    window.handleAuth = async () => {
        const e = document.getElementById('email').value.trim();
        const p = document.getElementById('pass').value.trim();
        try { await signInWithEmailAndPassword(auth, e, p); }
        catch { try { await createUserWithEmailAndPassword(auth, e, p); } catch(err){ alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"); } }
    };

    window.saveNewName = async () => {
        const name = document.getElementById('user-name-input').value.trim();
        if(name) {
            await updateProfile(auth.currentUser, { displayName: name });
            await set(ref(db, 'users/' + auth.currentUser.uid), { 
                uid: auth.currentUser.uid, 
                name: name, 
                email: auth.currentUser.email 
            });
            location.reload();
        }
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async u => {
        me = u;
        if(u) {
            const snap = await get(ref(db, 'users/' + u.uid));
            if(!snap.exists()) {
                switchScreen('screen-name');
            } else {
                switchScreen('screen-main');
                document.getElementById('my-display-name').innerText = snap.val().name + (u.email === ADMIN_EMAIL ? " üëë" : "");
                loadUsers();
            }
        } else { switchScreen('screen-auth'); }
    });

    function loadUsers() {
        onValue(ref(db, 'users'), snap => {
            allUsers = [];
            snap.forEach(c => { if(c.val().uid !== me.uid) allUsers.push(c.val()); });
            renderUsers(allUsers);
        });
    }

    window.filterUsers = () => {
        const q = document.getElementById('user-search').value.toLowerCase();
        renderUsers(allUsers.filter(u => u.name.toLowerCase().includes(q)));
    };

    function renderUsers(users) {
        const list = document.getElementById('user-list');
        list.innerHTML = "";
        users.forEach(u => {
            const isAdmin = u.email === ADMIN_EMAIL;
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `<div class="avatar ${isAdmin ? 'is-admin-border' : ''}">${u.name[0].toUpperCase()}</div><b>${u.name}</b> ${isAdmin ? '<span class="crown">üëë</span>' : ''}`;
            div.onclick = () => openChat(u);
            list.appendChild(div);
        });
    }

    window.openChat = (target) => {
        currentChatId = me.uid < target.uid ? me.uid + "_" + target.uid : target.uid + "_" + me.uid;
        switchScreen('screen-chat');
        document.getElementById('chat-with-name').innerText = target.name;
        document.getElementById('chat-avatar').innerText = target.name[0].toUpperCase();
        listenMsgs();
        listenTyping(target.uid);
    };

    window.handleTyping = () => {
        set(ref(db, `typing/${currentChatId}/${me.uid}`), document.getElementById('m-input').value.length > 0);
        onDisconnect(ref(db, `typing/${currentChatId}/${me.uid}`)).set(false);
    };

    function listenTyping(tUid) {
        onValue(ref(db, `typing/${currentChatId}/${tUid}`), snap => {
            document.getElementById('typing-status').innerText = snap.val() ? "–ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
        });
    }

    function listenMsgs() {
        onValue(ref(db, 'chats/' + currentChatId), snap => {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const isAdmin = m.e === ADMIN_EMAIL;
                const div = document.createElement('div');
                div.className = `message ${m.s === me.uid ? 'my' : 'other'} ${isAdmin ? 'admin-glow' : ''}`;
                div.innerHTML = `${m.x} <span class="time">${new Date(m.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
                if(me.email === ADMIN_EMAIL) div.onclick = () => { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) remove(ref(db, `chats/${currentChatId}/${c.key}`)); };
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMsg = () => {
        const txt = document.getElementById('m-input').value.trim();
        if(!txt) return;
        push(ref(db, 'chats/' + currentChatId), { s: me.uid, x: txt, t: Date.now(), e: me.email });
        document.getElementById('m-input').value = "";
        set(ref(db, `typing/${currentChatId}/${me.uid}`), false);
    };

    window.showMain = () => { switchScreen('screen-main'); if(currentChatId) set(ref(db, `typing/${currentChatId}/${me.uid}`), false); };

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
