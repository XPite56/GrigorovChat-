<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GrigorovChat Admin Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        :root { --p: #6c5ce7; --bg: #0f0c29; --glass: rgba(255,255,255,0.1); --grad: linear-gradient(135deg, #0f0c29, #302b63, #24243e); --admin: #ff4757; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--grad); color: white; height: 100vh; display: flex; overflow: hidden; }
        .screen { display: none; flex-direction: column; width: 100%; height: 100vh; position: absolute; }
        .active { display: flex; }
        .card { background: #1a1a2e; padding: 30px; border-radius: 24px; width: 90%; max-width: 360px; text-align: center; border: 1px solid var(--glass); margin: auto; }
        input { background: rgba(255,255,255,0.1); border: 1px solid transparent; padding: 12px; border-radius: 15px; color: white; outline: none; width: 100%; margin-bottom: 10px; font-size: 16px; }
        .btn { background: var(--p); border: none; color: white; padding: 12px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; }
        .header { padding: 15px 20px; background: rgba(255,255,255,0.05); display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass); }
        .user-item { padding: 15px; margin: 8px 15px; background: var(--glass); border-radius: 18px; display: flex; align-items: center; gap: 15px; cursor: pointer; position: relative; }
        .msg-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 18px; position: relative; cursor: pointer; }
        .my { align-self: flex-end; background: var(--p); }
        .other { align-self: flex-start; background: var(--glass); }
        .admin-badge { background: var(--admin); font-size: 10px; padding: 2px 6px; border-radius: 5px; margin-left: 5px; }
        .del-btn { color: var(--admin); font-size: 10px; margin-top: 5px; display: none; }
        .is-admin .del-btn { display: block; }
        .input-bar { padding: 15px; background: #1a1a2e; display: flex; gap: 10px; }
    </style>
</head>
<body id="main-body">

    <div id="screen-auth" class="screen active">
        <div class="card">
            <h1>GrigorovChat</h1><br>
            <input type="text" id="user-in" placeholder="Ваш ник">
            <input type="password" id="pass-in" placeholder="Пароль">
            <button class="btn" onclick="handleAuth()">ВХОД</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <header class="header"><b>Чаты</b> <span id="admin-tag" class="admin-badge" style="display:none;">ADMIN</span> <button onclick="location.reload()" style="margin-left:auto; background:none; border:none; color:#ff4757;">Выход</button></header>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="screen-chat" class="screen">
        <header class="header"><span onclick="app.showMain()" style="cursor:pointer;">←</span> <b id="chat-title"></b></header>
        <div id="msg-box" class="msg-box"></div>
        <div class="input-bar"><input type="text" id="m-input" style="margin:0;"><button onclick="app.send()" class="btn" style="width:60px;">➤</button></div>
    </div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const user = gun.user().recall({sessionStorage: true});

    // УКАЖИ СВОЙ НИК ЗДЕСЬ, ЧТОБЫ СТАТЬ АДМИНОМ
    const ADMIN_NICKNAME = "Daniil"; 

    const app = {
        target: '',
        isAdmin: false,
        showMain() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-main').classList.add('active');
        },
        send() {
            const val = document.getElementById('m-input').value.trim();
            if(!val) return;
            const roomID = [user.is.alias, this.target].sort().join('_');
            gun.get('grigorov_v4_rooms').get(roomID).set({
                from: user.is.alias,
                text: val,
                time: Date.now()
            });
            document.getElementById('m-input').value = "";
        },
        deleteMsg(msgID, roomID) {
            if(!this.isAdmin) return;
            if(confirm("Удалить это сообщение для всех?")) {
                gun.get('grigorov_v4_rooms').get(roomID).get(msgID).put(null);
                alert("Сообщение удалено. Перезайдите в чат.");
            }
        }
    };

    function handleAuth() {
        const u = document.getElementById('user-in').value.trim();
        const p = document.getElementById('pass-in').value.trim();
        user.auth(u, p, (at) => {
            if(at.err) {
                user.create(u, p, (res) => {
                    if(res.err) alert(res.err);
                    else alert("Зарегистрировано! Нажми ВХОД.");
                });
            } else { goMain(); }
        });
    }

    function goMain() {
        if(user.is.alias === ADMIN_NICKNAME) {
            app.isAdmin = true;
            document.getElementById('admin-tag').style.display = "inline-block";
            document.getElementById('main-body').classList.add('is-admin');
        }

        document.getElementById('screen-auth').classList.remove('active');
        document.getElementById('screen-main').classList.add('active');
        
        gun.get('grigorov_v4_users').get(user.is.alias).put({name: user.is.alias});

        const list = document.getElementById('user-list');
        gun.get('grigorov_v4_users').map().on((data, id) => {
            if(!data || id === user.is.alias || document.getElementById('u-'+id)) return;
            const div = document.createElement('div');
            div.id = 'u-' + id;
            div.className = 'user-item';
            div.innerHTML = `<b>${id}</b> ${id === ADMIN_NICKNAME ? '<span class="admin-badge">ADMIN</span>' : ''}`;
            div.onclick = () => openChat(id);
            list.appendChild(div);
        });
    }

    function openChat(id) {
        app.target = id;
        document.getElementById('chat-title').innerText = id;
        document.getElementById('msg-box').innerHTML = "";
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-chat').classList.add('active');
        
        const roomID = [user.is.alias, id].sort().join('_');
        gun.get('grigorov_v4_rooms').get(roomID).map().on((msgData, msgID) => {
            if(!msgData || !msgData.text) return;
            const mDiv = document.createElement('div');
            mDiv.className = `message ${msgData.from === user.is.alias ? 'my' : 'other'}`;
            mDiv.innerHTML = `
                <div>${msgData.text}</div>
                <div class="del-btn" onclick="app.deleteMsg('${msgID}', '${roomID}')">Удалить</div>
            `;
            document.getElementById('msg-box').appendChild(mDiv);
            document.getElementById('msg-box').scrollTop = 99999;
        });
    }
</script>
</body>
</html>
